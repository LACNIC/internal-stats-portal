{% extends "../base.html" %}
{% load staticfiles %}
{% load i18n %}

{% block title %}
    Home
{% endblock %}

{% block content %}

    <div class="jumbotron">
        <h1>
            Open <font>Data</font>
        </h1>

        <h3>Acceso a datos sobre recursos de Internet relevados por LACNIC</h3>

        <p>
            Este portal está dedicado a mostrar y disponibilizar datasets generados por LACNIC de diversos ámbitos a
            modo experimental o de estadíticas generales sobre los recursos asignados en la región.
        </p>
        <p>
            Es un portal de uso público que brinda la posibilidad de descargar los datos descriptos en formatos estándar
            para uso personal.
        </p>
    </div>

    <div>

        <div id="leftpanel" class="col-xs-12 col-md-3">
            <div style="float:left;">
                <h2>Categorías</h2>
                <ul>
                    {% for c in cat %}
                        <li>
                            <a href="{% url "categoria" %}{{ c }}">{{ c }}</a>
                        </li>

                    {% endfor %}
                </ul>

            </div>


            <div style="float:left;">
                <h2>Lo más visto</h2>
                <ul>
                    {% for p in most %}
                        <li>
                            <a href="{% url "dato" %}{{ p.name }}">{{ p.name }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <div style="float:left;">
                <h2>Recientemente agregado</h2>
                <ul>
                    {% for p in recent %}

                        <li>
                            <a href="{% url "dato" %}{{ p.name }}">{{ p.name }}</a>
                        </li>

                    {% endfor %}
                </ul>

            </div>
        </div>

        <!-- Charts -->
        <div class="col-xs-12 col-md-9">
            <div class="col-xs-12 col-md-6">
                <a href="{% url "dato" %}Asignaciones VS Anuncios visibles IPv6"><h2>Asignaciones VS Anuncios visibles IPv6</h2></a>
                <div id="chart_test"></div>
            </div>

            <div class="col-xs-12 col-md-6">
                <a href="{% url "dato" %}Espacio IPv4 disponible"><h2>Espacio IPv4 disponible</h2></a>
                <div id="chart_test2"></div>
            </div>

            <div class="col-xs-12 col-md-6">
                <a href="{% url "dato" %}DSC data registros A"><h2> DSC data registros A</h2></a>
                <div id="chart_test3"></div>
            </div>

            <div class="col-xs-12 col-md-6">
                <a href="{% url "dato" %}DSC data registros AAAA"><h2> DSC data registros AAAA</h2></a>
                <div id="chart_test4"></div>
            </div>
        </div>


    </div>


{% endblock %}

{% block afterbody %}


    <script>

        function parseDate(fecha) {
            var s = fecha.slice(5, fecha.length);
            var d = s.split(", ");
            var mes = Number(d[1]) + 1;
            if (mes < 10) {
                mes = "0" + mes.toString();
            }
            var date = d[0] + "-" + mes + "-" + d[2];
            return date;
        }

        function chart_1(b) {
            var rows = b['rows'];
            var x = [];
            var y1 = [];
            var y2 = [];

            var allocations = 0;
            var announces = 0;
            var aniomes = "";

            for (i = 0; i < rows.length; i++) {
                var fecha = parseDate(rows[i]['c'][0]['v']);
                aniomes = fecha.slice(0, 7)

                var alloc = Number(rows[i]['c'][1]['v']);
                var annou = Number(rows[i]['c'][2]['v']);

                if (i + 1 < rows.length) {
                    if (aniomes == parseDate(rows[i + 1]['c'][0]['v']).slice(0, 7)) {
                        allocations = allocations + alloc
                        announces = announces + annou
                    } else {
                        x.push(aniomes + "-01")
                        y1.push(allocations)
                        y2.push(announces)
                        allocations = 0;
                        announces = 0;
                    }
                }
            }

            CHARTS.draw({
                x: x,
                ys: [y1, y2],
                labels: ['Asignado', 'Anunciado'],
                kind: 'LineChart',
                divId: 'chart_test',
                xType: 'date',
                colors: ['C53425', '009DCA'],
                my_options: {
                    height: 300,
                    vAxis: {format: 'short', title: 'Direcciones IP'},
                    chartArea: {
                        left: "50",
                        top: "5"
                    }
                }
            });

        }

        function chart_2(b) {
            var rows = b['rows'];
            var x = [];
            var y = [];

            for (i = 0; i < rows.length; i++) {
                var fecha = parseDate(rows[i]['c'][0]['v']);
                var valor = Number(rows[i]['c'][1]['v']);
                x.push(fecha)
                y.push(valor)
            }

            CHARTS.draw({
                x: x,
                ys: [y],
                labels: ['IPv4 disponible'],
                kind: 'LineChart',
                divId: 'chart_test2',
                xType: 'date',
                colors: ['C53425'],
                my_options: {
                    height: 300,
                    vAxis: {format: 'short'},
                    chartArea: {
                        left: "30",
                        top: "5"
                    }
                }
            });

        }

        function chart_3(b) {
            var datos = b['results'][0]['series'][0]['values'];

            var x = [];
            var y = [];

            for (i = 0; i < datos.length; i++) {
                var fecha = datos[i][0].split("T")[0];
                var valor = Number(datos[i][1]);
{#                console.log(fecha.split("T")[0])#}
{#                console.log(valor)#}
                x.push(fecha)
                y.push(valor)
            }

            CHARTS.draw({
                x: x.slice(x.length-200, x.length),
                ys: [y.slice(y.length-200, y.length)],
                labels: ['DSC data QType A'],
                kind: 'LineChart',
                divId: 'chart_test3',
                xType: 'date',
                colors: ['C53425'],
                my_options: {
                    height: 300,
                    chartArea: {
                        left: "30",
                        top: "5"
                    }
                }
            });

        }

        function chart_4(b) {
            console.log(b[1])
            var v4 = b[0]['results'][0]['series'][0]['values'];
            var v6 = b[1]['results'][0]['series'][0]['values'];

            var x = [];
            var y4 = [];
            var y6 = [];

            for (i = 0; i < v4.length; i++) {
                var fecha = v4[i][0].split("T")[0];
                var valor4 = Number(v4[i][1]);
                var valor6 = Number(v6[i][1]);
                x.push(fecha)
                y4.push(valor4)
                y6.push(valor6)
            }

            CHARTS.draw({
                x: x.slice(x.length-100, x.length),
                ys: [y4.slice(y4.length-100, y4.length), y6.slice(y6.length-100, y6.length)],
                labels: ['DSC data QType A', 'DSC data QType AAAA'],
                kind: 'LineChart',
                divId: 'chart_test4',
                xType: 'date',
                colors: ['C53425', '009DCA'],
                my_options: {
                    height: 300,
                    chartArea: {
                        left: "30",
                        top: "5"
                    }
                }
            });

        }

        fetch('https://portaldedatos.dev.lacnic.net/static/data/asignaciones_vs_anuncios_visibles_ipv6-2017-09-01.json').then(function (a) {
            return a.json()
        }).then(function (b) {
            chart_1(b)
        });

        fetch('https://portaldedatos.dev.lacnic.net/static/data/available_ipv4_space-2017-08-23.json').then(function (a) {
            return a.json()
        }).then(function (b) {
            chart_2(b)
        });

        fetch('https://portaldedatos.dev.lacnic.net/dsc-data/dsc.qtype_a.server_dip6.1d.json').then(function (a) {
            return a.json()
        }).then(function (b) {
            chart_3(b)
        });

        var urls = [fetch('https://portaldedatos.dev.lacnic.net/dsc-data/dsc.qtype_a.server_dip6.1d.json'), fetch('https://portaldedatos.dev.lacnic.net/dsc-data/dsc.qtype_aaaa.server_dip6.1d.json')]

        Promise.all(urls).then(function (a){
            var jsons = [a[0].json(), a[1].json()]
            return Promise.all(jsons)
        }).then(function (b){
            chart_4(b)
        });

    </script>
{% endblock %}